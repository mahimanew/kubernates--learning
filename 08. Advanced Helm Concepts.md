
# **ğŸ“Œ Advanced Helm Concepts**

### âœ… **1. Helm Architecture & Components**
Helm consists of:
1ï¸âƒ£ **Helm CLI** â€“ Command-line tool to interact with Helm.  
2ï¸âƒ£ **Helm Chart** â€“ A collection of YAML templates that define Kubernetes resources.  
3ï¸âƒ£ **Chart Repository** â€“ A place to store and share Helm charts (e.g., ArtifactHub, JFrog, AWS ECR, GitHub).  
4ï¸âƒ£ **Helm Release** â€“ An instance of a Helm chart deployed in a Kubernetes cluster.  
5ï¸âƒ£ **Tiller (Removed in Helm 3)** â€“ Previously used for server-side chart management (deprecated).  

---

### âœ… **2. Helm Chart Structure**
Every Helm chart follows a specific structure:
```sh
mychart/
â”œâ”€â”€ charts/          # Subcharts (dependencies)
â”œâ”€â”€ templates/       # YAML templates for Kubernetes resources
â”‚   â”œâ”€â”€ deployment.yaml
â”‚   â”œâ”€â”€ service.yaml
â”‚   â”œâ”€â”€ ingress.yaml
â”‚   â”œâ”€â”€ _helpers.tpl # Template helper functions
â”‚   â”œâ”€â”€ NOTES.txt    # Post-install notes
â”œâ”€â”€ values.yaml      # Default configuration values
â”œâ”€â”€ Chart.yaml       # Metadata about the Helm chart
â””â”€â”€ README.md        # Documentation
```
ğŸ”¹ **Key File: `values.yaml`**  
It allows customization of Helm charts **without modifying the templates**.

---

### âœ… **3. Writing Advanced Helm Templates**
**Helm uses Go templating** to create dynamic YAML files.

ğŸ“Œ **Example: Using Variables in Templates (`deployment.yaml`)**
```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ .Release.Name }}-nginx
  labels:
    app: {{ .Chart.Name }}
spec:
  replicas: {{ .Values.replicaCount }}
  selector:
    matchLabels:
      app: {{ .Chart.Name }}
  template:
    metadata:
      labels:
        app: {{ .Chart.Name }}
    spec:
      containers:
      - name: nginx
        image: "{{ .Values.image.repository }}:{{ .Values.image.tag }}"
        ports:
        - containerPort: 80
```

ğŸ“Œ **Example: Default Values (`values.yaml`)**
```yaml
replicaCount: 2

image:
  repository: nginx
  tag: latest
```

ğŸ”¹ **Apply the chart with custom values:**
```sh
helm install my-nginx ./mychart -f values.yaml
```

---

### âœ… **4. Using `_helpers.tpl` for Code Reusability**
To avoid repeating values, Helm uses **template functions**.

ğŸ“Œ **Example: `_helpers.tpl`**
```yaml
{{- define "nginx.fullname" -}}
{{ .Release.Name }}-{{ .Chart.Name }}
{{- end }}
```

ğŸ“Œ **Use it in `deployment.yaml`**
```yaml
metadata:
  name: {{ include "nginx.fullname" . }}
```

ğŸ”¹ This makes your templates modular and reusable!

---

### âœ… **5. Managing Dependencies in Helm**
Helm supports **subcharts** for managing dependencies.

ğŸ“Œ **Example: Define Dependencies in `Chart.yaml`**
```yaml
dependencies:
  - name: redis
    version: 6.0.1
    repository: https://charts.bitnami.com/bitnami
```

ğŸ”¹ **Update dependencies:**  
```sh
helm dependency update
```

ğŸ”¹ **Package the chart (with dependencies):**  
```sh
helm package mychart
```

---

### âœ… **6. Helm Hooks â€“ Automate Pre/Post Tasks**
Hooks allow you to run tasks **before** or **after** a Helm release.

ğŸ“Œ **Example: Run a Job Before Deployment (`pre-install-hook.yaml`)**
```yaml
apiVersion: batch/v1
kind: Job
metadata:
  name: "{{ .Release.Name }}-pre-install"
  annotations:
    "helm.sh/hook": pre-install
spec:
  template:
    spec:
      containers:
      - name: busybox
        image: busybox
        command: ['sh', '-c', 'echo Pre-install task']
      restartPolicy: Never
```

ğŸ”¹ **Available Helm hooks:**
- `pre-install`  
- `post-install`  
- `pre-delete`  
- `post-delete`  
- `pre-upgrade`  
- `post-upgrade`  

---

### âœ… **7. Helm Chart Lifecycle â€“ Upgrade & Rollback**
ğŸ”¹ **Upgrade a release:**  
```sh
helm upgrade my-nginx ./mychart -f values.yaml
```

ğŸ”¹ **Rollback to a previous version:**  
```sh
helm rollback my-nginx 1
```

ğŸ”¹ **List release history:**  
```sh
helm history my-nginx
```

---

### âœ… **8. Helm Security Best Practices**
ğŸ”¹ **Use Private Chart Repositories** â€“ Avoid public repositories for internal apps.  
ğŸ”¹ **Enable Role-Based Access Control (RBAC)** â€“ Limit Helm operations based on user roles.  
ğŸ”¹ **Use Signed Helm Charts** â€“ Ensure integrity and authenticity.  

ğŸ“Œ **Sign a Helm Chart:**  
```sh
helm package --sign --key my-key --keyring my-keyring.gpg mychart/
```

ğŸ“Œ **Verify a signed chart:**  
```sh
helm verify mychart-0.1.0.tgz
```

---

### âœ… **9. Hosting Helm Charts in a Private Repository**
1ï¸âƒ£ **Create an OCI-compatible Helm repo in AWS ECR:**  
```sh
aws ecr create-repository --repository-name my-helm-charts
```

2ï¸âƒ£ **Login to ECR:**  
```sh
aws ecr get-login-password | helm registry login --username AWS --password-stdin <AWS_ECR_URL>
```

3ï¸âƒ£ **Push a Helm chart to ECR:**  
```sh
helm push mychart <AWS_ECR_URL>/my-helm-charts
```

4ï¸âƒ£ **Pull and install the Helm chart from ECR:**  
```sh
helm pull <AWS_ECR_URL>/my-helm-charts/mychart
helm install myapp mychart
```

---

### âœ… **10. Automating Helm with CI/CD (GitLab Example)**
ğŸ“Œ **Example: `.gitlab-ci.yml`**
```yaml
stages:
  - deploy

deploy:
  stage: deploy
  script:
    - helm upgrade --install myapp ./mychart -f values.yaml
  only:
    - main
```

ğŸ”¹ This automatically deploys your Helm chart when code is pushed to the `main` branch.

---

# **ğŸ¯ Hands-on Tasks**
âœ… **Task 1:** Create a Helm chart for a Go application.  
âœ… **Task 2:** Implement Helm hooks to run a pre-install Job.  
âœ… **Task 3:** Deploy a multi-tier application using Helm dependencies (e.g., Nginx + Redis).  
âœ… **Task 4:** Set up a private Helm repository and push charts to it.  
âœ… **Task 5:** Automate Helm deployments using GitLab CI/CD.  

---



